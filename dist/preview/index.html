<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>n8n Templates – Local Preview</title>
  <style>
    :root { --fg:#111; --muted:#666; --bg:#fff; --accent:#2563eb; }
    html, body { margin:0; padding:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; color:var(--fg); background:var(--bg); }
    header { padding:16px 20px; border-bottom:1px solid #eee; position:sticky; top:0; background:var(--bg); z-index:10; }
    h1 { font-size:18px; margin:0 0 8px; }
    .controls { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .controls input[type="search"], .controls select { padding:8px 10px; border:1px solid #ddd; border-radius:6px; min-width:220px; }
    .controls .stat { color:var(--muted); margin-left:auto; }
    main { padding:16px 20px; }
    table { width:100%; border-collapse:collapse; }
    th, td { text-align:left; padding:10px 8px; border-bottom:1px solid #eee; vertical-align:top; }
    th { font-weight:600; font-size:13px; color:var(--muted); }
    tbody tr:hover { background:#fafafa; }
    .title { font-weight:600; }
    .muted { color:var(--muted); font-size:12px; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #e5e7eb; border-radius:999px; font-size:12px; color:#374151; background:#f9fafb; }
    a { color:var(--accent); text-decoration:none; }
    a:hover { text-decoration:underline; }
    .nowrap { white-space:nowrap; }
  </style>
  <script>
    async function loadIndex() {
      const res = await fetch('/all_templates.json', { cache: 'no-store' });
      if (!res.ok) throw new Error('Failed to load all_templates.json');
      return /** @type {Array} */ (await res.json());
    }

    /**
     * @param {Array} rows
     */
    function renderRows(rows) {
      const tbody = document.querySelector('#rows');
      tbody.innerHTML = '';
      for (const r of rows) {
        const tr = document.createElement('tr');

        const titleTd = document.createElement('td');
        const title = document.createElement('div');
        title.className = 'title';
        title.textContent = r.title || r.relative_path;
        const sub = document.createElement('div');
        sub.className = 'muted';
        sub.textContent = r.relative_path;
        titleTd.appendChild(title);
        titleTd.appendChild(sub);

        const catTd = document.createElement('td');
        const cat = document.createElement('span');
        cat.className = 'pill';
        cat.textContent = r.category || '—';
        catTd.appendChild(cat);

        const nodesTd = document.createElement('td');
        nodesTd.className = 'nowrap';
        nodesTd.textContent = r.nodes_count == null ? '—' : String(r.nodes_count);

        const sizeTd = document.createElement('td');
        sizeTd.className = 'nowrap';
        sizeTd.textContent = formatBytes(r.file_size_bytes);

        const mtimeTd = document.createElement('td');
        mtimeTd.className = 'nowrap';
        mtimeTd.textContent = r.modified_iso;

        const openTd = document.createElement('td');
        const a = document.createElement('a');
        a.textContent = 'Open JSON';
        a.href = '/' + r.relative_path;
        a.rel = 'noopener noreferrer';
        a.target = '_blank';
        openTd.appendChild(a);

        tr.appendChild(titleTd);
        tr.appendChild(catTd);
        tr.appendChild(nodesTd);
        tr.appendChild(sizeTd);
        tr.appendChild(mtimeTd);
        tr.appendChild(openTd);
        tbody.appendChild(tr);
      }
    }

    function formatBytes(bytes) {
      if (!Number.isFinite(bytes)) return '—';
      const thresh = 1024;
      if (Math.abs(bytes) < thresh) return bytes + ' B';
      const units = ['KB','MB','GB','TB'];
      let u = -1;
      do { bytes /= thresh; ++u; } while (Math.abs(bytes) >= thresh && u < units.length - 1);
      return bytes.toFixed(1) + ' ' + units[u];
    }

    function unique(arr) { return Array.from(new Set(arr)); }

    /**
     * @param {Array} all
     */
    function applyFilter(all) {
      const q = document.querySelector('#q').value.trim().toLowerCase();
      const category = document.querySelector('#category').value;
      const sort = document.querySelector('#sort').value;
      let filtered = all;
      if (category !== '__ALL__') {
        filtered = filtered.filter(r => (r.category || '') === category);
      }
      if (q) {
        filtered = filtered.filter(r => {
          const hay = `${r.title}\n${r.relative_path}`.toLowerCase();
          return q.split(/\s+/).every(k => hay.includes(k));
        });
      }
      if (sort === 'mtime_desc') {
        filtered = filtered.slice().sort((a,b) => (a.modified_iso < b.modified_iso ? 1 : -1));
      } else if (sort === 'nodes_desc') {
        filtered = filtered.slice().sort((a,b) => (Number(b.nodes_count||0) - Number(a.nodes_count||0)));
      } else if (sort === 'title_asc') {
        filtered = filtered.slice().sort((a,b) => String(a.title||'').localeCompare(String(b.title||'')));
      }
      document.querySelector('#count').textContent = String(filtered.length);
      renderRows(filtered);
    }

    async function boot() {
      const all = await loadIndex();
      const categories = ['__ALL__', ...unique(all.map(r => r.category || '').filter(Boolean))];
      const sel = document.querySelector('#category');
      for (const c of categories) {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = (c === '__ALL__') ? 'All categories' : c;
        sel.appendChild(opt);
      }
      document.querySelector('#total').textContent = String(all.length);
      const inputs = [document.querySelector('#q'), document.querySelector('#category'), document.querySelector('#sort')];
      for (const el of inputs) el.addEventListener('input', () => applyFilter(all));
      applyFilter(all);
    }

    window.addEventListener('DOMContentLoaded', () => { boot().catch(err => {
      const tbody = document.querySelector('#rows');
      tbody.innerHTML = '<tr><td colspan="6">Failed to load index: ' + String(err) + '</td></tr>';
    }); });
  </script>
  
</head>
<body>
  <header>
    <h1>n8n Templates – Local Preview</h1>
    <div class="controls">
      <input id="q" type="search" placeholder="Search title or path..." />
      <select id="category" aria-label="Category"></select>
      <select id="sort" aria-label="Sort">
        <option value="mtime_desc">Sort by modified (newest)</option>
        <option value="nodes_desc">Sort by node count (desc)</option>
        <option value="title_asc">Sort by title (A→Z)</option>
      </select>
      <div class="stat">Showing <span id="count">0</span> of <span id="total">0</span></div>
    </div>
  </header>

  <main>
    <table>
      <thead>
        <tr>
          <th>Template</th>
          <th>Category</th>
          <th>Nodes</th>
          <th>Size</th>
          <th>Modified</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="6" class="muted">Loading…</td></tr>
      </tbody>
    </table>
  </main>
</body>
</html>

